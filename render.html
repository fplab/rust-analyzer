
<style>
body                { margin: 0; }
pre                 { color: #DCDCCC; background: #3F3F3F; font-size: 22px; padding: 0.4em; }

.comment            { color: #7F9F7F; }
.string             { color: #CC9393; }
.function           { color: #93E0E3; }
.parameter          { color: #94BFF3; }
.builtin            { color: #DD6718; }
.text               { color: #DCDCCC; }
.attribute          { color: #94BFF3; }
.literal            { color: #BFEBBF; }
.macro              { color: #94BFF3; }
.variable           { color: #DCDCCC; }
.variable\.mut     { color: #DCDCCC; text-decoration: underline; }

.keyword            { color: #F0DFAF; }
.keyword\.unsafe   { color: #DFAF8F; }
.keyword\.control  { color: #F0DFAF; font-weight: bold; }
</style>
<pre><code><span class="comment">//! FIXME: write short doc here</span>

<span class="keyword">use</span> <span class="text">std</span>::<span class="text">fmt</span>::{<span class="keyword">self</span>, <span class="text">Display</span>};

<span class="keyword">use</span> <span class="text">hir</span>::{<span class="text">Docs</span>, <span class="text">Documentation</span>, <span class="text">HasSource</span>};
<span class="keyword">use</span> <span class="text">join_to_string</span>::<span class="text">join</span>;
<span class="keyword">use</span> <span class="text">ra_syntax</span>::<span class="text">ast</span>::{<span class="keyword">self</span>, <span class="text">AstNode</span>, <span class="text">NameOwner</span>, <span class="text">VisibilityOwner</span>};
<span class="keyword">use</span> <span class="text">std</span>::<span class="text">convert</span>::<span class="text">From</span>;

<span class="keyword">use</span> <span class="keyword">crate</span>::{
    <span class="text">db</span>,
    <span class="text">display</span>::{<span class="text">generic_parameters</span>, <span class="text">where_predicates</span>},
};

<span class="comment">/// Contains information about a function signature</span>
<span class="attribute">#</span><span class="attribute">[</span><span class="attribute">derive</span><span class="attribute">(</span><span class="attribute">Debug</span><span class="attribute">)</span><span class="attribute">]</span>
<span class="keyword">pub</span> <span class="keyword">struct</span> <span class="type">FunctionSignature</span> {
    <span class="comment">/// Optional visibility</span>
    <span class="keyword">pub</span> <span class="field">visibility</span>: <span class="text">Option</span>&lt;<span class="text">String</span>&gt;,
    <span class="comment">/// Name of the function</span>
    <span class="keyword">pub</span> <span class="field">name</span>: <span class="text">Option</span>&lt;<span class="text">String</span>&gt;,
    <span class="comment">/// Documentation for the function</span>
    <span class="keyword">pub</span> <span class="field">doc</span>: <span class="text">Option</span>&lt;<span class="text">Documentation</span>&gt;,
    <span class="comment">/// Generic parameters</span>
    <span class="keyword">pub</span> <span class="field">generic_parameters</span>: <span class="text">Vec</span>&lt;<span class="text">String</span>&gt;,
    <span class="comment">/// Parameters of the function</span>
    <span class="keyword">pub</span> <span class="field">parameters</span>: <span class="text">Vec</span>&lt;<span class="text">String</span>&gt;,
    <span class="comment">/// Optional return type</span>
    <span class="keyword">pub</span> <span class="field">ret_type</span>: <span class="text">Option</span>&lt;<span class="text">String</span>&gt;,
    <span class="comment">/// Where predicates</span>
    <span class="keyword">pub</span> <span class="field">where_predicates</span>: <span class="text">Vec</span>&lt;<span class="text">String</span>&gt;,
}

<span class="keyword">impl</span> <span class="type">FunctionSignature</span> {
    <span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="function">with_doc_opt</span>(<span class="keyword">mut</span> <span class="keyword">self</span>, <span class="variable">doc</span>: <span class="text">Option</span>&lt;<span class="text">Documentation</span>&gt;) -&gt; <span class="type">Self</span> {
        <span class="keyword">self</span>.<span class="field">doc</span> = <span class="variable">doc</span>;
        <span class="keyword">self</span>
    }

    <span class="keyword">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="function">from_hir</span>(<span class="variable">db</span>: &<span class="text">db</span>::<span class="text">RootDatabase</span>, <span class="variable">function</span>: <span class="text">hir</span>::<span class="text">Function</span>) -&gt; <span class="type">Self</span> {
        <span class="keyword">let</span> <span class="variable">doc</span> = <span class="variable">function</span>.<span class="text">docs</span>(<span class="variable">db</span>);
        <span class="keyword">let</span> <span class="variable">ast_node</span> = <span class="variable">function</span>.<span class="text">source</span>(<span class="variable">db</span>).<span class="text">ast</span>;
        <span class="type">FunctionSignature</span>::<span class="text">from</span>(&<span class="variable">ast_node</span>).<span class="text">with_doc_opt</span>(<span class="variable">doc</span>)
    }
}

<span class="keyword">impl</span> <span class="text">From</span>&lt;&<span class="parameter">'_</span> <span class="text">ast</span>::<span class="text">FnDef</span>&gt; <span class="keyword.control">for</span> <span class="type">FunctionSignature</span> {
    <span class="keyword">fn</span> <span class="function">from</span>(<span class="variable">node</span>: &<span class="text">ast</span>::<span class="text">FnDef</span>) -&gt; <span class="type">FunctionSignature</span> {
        <span class="keyword">fn</span> <span class="function">param_list</span>(<span class="variable">node</span>: &<span class="text">ast</span>::<span class="text">FnDef</span>) -&gt; <span class="text">Vec</span>&lt;<span class="text">String</span>&gt; {
            <span class="keyword">let</span> <span class="keyword">mut</span> <span class="variable.mut">res</span> = <span class="macro">vec</span><span class="macro">!</span>[];
            <span class="keyword.control">if</span> <span class="keyword">let</span> <span class="text">Some</span>(<span class="variable">param_list</span>) = <span class="variable">node</span>.<span class="text">param_list</span>() {
                <span class="keyword.control">if</span> <span class="keyword">let</span> <span class="text">Some</span>(<span class="variable">self_param</span>) = <span class="variable">param_list</span>.<span class="text">self_param</span>() {
                    <span class="variable.mut">res</span>.<span class="text">push</span>(<span class="variable">self_param</span>.<span class="text">syntax</span>().<span class="text">text</span>().<span class="text">to_string</span>())
                }

                <span class="variable.mut">res</span>.<span class="text">extend</span>(<span class="variable">param_list</span>.<span class="text">params</span>().<span class="text">map</span>(|<span class="variable">param</span>| <span class="variable">param</span>.<span class="text">syntax</span>().<span class="text">text</span>().<span class="text">to_string</span>()));
            }
            <span class="variable.mut">res</span>
        }

        <span class="type">FunctionSignature</span> {
            <span class="field">visibility</span>: <span class="variable">node</span>.<span class="text">visibility</span>().<span class="text">map</span>(|<span class="variable">n</span>| <span class="variable">n</span>.<span class="text">syntax</span>().<span class="text">text</span>().<span class="text">to_string</span>()),
            <span class="field">name</span>: <span class="variable">node</span>.<span class="text">name</span>().<span class="text">map</span>(|<span class="variable">n</span>| <span class="variable">n</span>.<span class="text">text</span>().<span class="text">to_string</span>()),
            <span class="field">ret_type</span>: <span class="variable">node</span>
                .<span class="text">ret_type</span>()
                .<span class="text">and_then</span>(|<span class="variable">r</span>| <span class="variable">r</span>.<span class="text">type_ref</span>())
                .<span class="text">map</span>(|<span class="variable">n</span>| <span class="variable">n</span>.<span class="text">syntax</span>().<span class="text">text</span>().<span class="text">to_string</span>()),
            <span class="field">parameters</span>: <span class="text">param_list</span>(<span class="variable">node</span>),
            <span class="field">generic_parameters</span>: <span class="text">generic_parameters</span>(<span class="variable">node</span>),
            <span class="field">where_predicates</span>: <span class="text">where_predicates</span>(<span class="variable">node</span>),
            <span class="comment">// docs are processed separately</span>
            <span class="field">doc</span>: <span class="text">None</span>,
        }
    }
}

<span class="keyword">impl</span> <span class="text">Display</span> <span class="keyword.control">for</span> <span class="type">FunctionSignature</span> {
    <span class="keyword">fn</span> <span class="function">fmt</span>(&<span class="keyword">self</span>, <span class="variable.mut">f</span>: &<span class="keyword">mut</span> <span class="text">fmt</span>::<span class="text">Formatter</span>) -&gt; <span class="text">fmt</span>::<span class="text">Result</span> {
        <span class="keyword.control">if</span> <span class="keyword">let</span> <span class="text">Some</span>(<span class="variable">t</span>) = &<span class="keyword">self</span>.<span class="field">visibility</span> {
            <span class="macro">write</span><span class="macro">!</span>(f, <span class="string">"{} "</span>, t)?;
        }

        <span class="keyword.control">if</span> <span class="keyword">let</span> <span class="text">Some</span>(<span class="variable">name</span>) = &<span class="keyword">self</span>.<span class="field">name</span> {
            <span class="macro">write</span><span class="macro">!</span>(f, <span class="string">"fn {}"</span>, name)?;
        }

        <span class="keyword.control">if</span> !<span class="keyword">self</span>.<span class="field">generic_parameters</span>.<span class="text">is_empty</span>() {
            <span class="text">join</span>(<span class="keyword">self</span>.<span class="field">generic_parameters</span>.<span class="text">iter</span>())
                .<span class="text">separator</span>(<span class="string">", "</span>)
                .<span class="text">surround_with</span>(<span class="string">"&lt;"</span>, <span class="string">"&gt;"</span>)
                .<span class="text">to_fmt</span>(<span class="variable.mut">f</span>)?;
        }

        <span class="text">join</span>(<span class="keyword">self</span>.<span class="field">parameters</span>.<span class="text">iter</span>()).<span class="text">separator</span>(<span class="string">", "</span>).<span class="text">surround_with</span>(<span class="string">"("</span>, <span class="string">")"</span>).<span class="text">to_fmt</span>(<span class="variable.mut">f</span>)?;

        <span class="keyword.control">if</span> <span class="keyword">let</span> <span class="text">Some</span>(<span class="variable">t</span>) = &<span class="keyword">self</span>.<span class="field">ret_type</span> {
            <span class="macro">write</span><span class="macro">!</span>(f, <span class="string">" -&gt; {}"</span>, t)?;
        }

        <span class="keyword.control">if</span> !<span class="keyword">self</span>.<span class="field">where_predicates</span>.<span class="text">is_empty</span>() {
            <span class="macro">write</span><span class="macro">!</span>(f, <span class="string">"\nwhere "</span>)?;
            <span class="text">join</span>(<span class="keyword">self</span>.<span class="field">where_predicates</span>.<span class="text">iter</span>()).<span class="text">separator</span>(<span class="string">",\n      "</span>).<span class="text">to_fmt</span>(<span class="variable.mut">f</span>)?;
        }

        <span class="text">Ok</span>(())
    }
}
</code></pre>
